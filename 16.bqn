#!/usr/bin/env cbqn

âŸ¨Split, B2D, _base, Range, PadâŸ© â† â€¢Import "lib.bqn"

inp â† âˆ¾(Â¯4âŠ¸â†‘2 _base)Â¨"0123456789ABCDEF"âŠâŠ‘â€¢FLines "16.txt"

# Part 1:
ptr â† 0
ReadBits â† {ptr +â†© ğ•©, inpâŠËœ(ptr-ğ•©)+â†•ğ•©}
#Adv â† {ğ•Š: ptr +â†© 1}
sum â† 0

GetPkt â† {
  GetPkt aâ€¿bâ€¿c: GetPkt @; # If given a packet value, ignore it.
  GetPkt @: # Read header and redirect to correct packet
  vâ€¿t â† B2DÂ¨ âŸ¨ReadBits 3, ReadBits 3âŸ©
  sum +â†© v
  GetPkt vâ€¿t;
  GetPkt vâ€¿4: # normal packet
  val â† B2D {ğ•©/ËœÂ¬(â‰ ğ•©)â¥Š0=â†•5}{inpâŠËœptr+â†•5, ğ•©âˆ¾ReadBits 5} â€¢_while_ {(0=â‰ ğ•©)âˆ¨inpâŠ‘Ëœptr-5} âŸ¨âŸ©
  âŸ¨v, 4, valâŸ©; 
  GetPkt vâ€¿t: # operator packet
  data â† {
    âŠ‘ReadBits 1 ? GetPkt âŸ (1+â†•B2D ReadBits 11) @;
	l â† ptr + B2D ReadBits 15
	res â† âŸ¨âŸ©
    {âŠ‘res âˆ¾â†© â‹ˆGetPkt ğ•©} â€¢_while_ {ğ•Š:ptr<l} @
	res
  }
  âŸ¨v, t, dataâŸ©
} 

expr â† GetPkt @
â€¢Show sum

# Part 2:
â€¢Show {
  ğ•Š vâ€¿4â€¿dat: dat;
  ğ•Š vâ€¿tâ€¿dat:
  (tâŠ‘+â€¿Ã—â€¿âŒŠâ€¿âŒˆâ€¿âŠ¢â€¿>â€¿<â€¿=)Â´ğ•ŠÂ¨dat
} expr
